<!DOCTYPE html>
<html>
  <head>
    <title>Messaging API</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common'
            class='remove'></script>
    <script class="remove">
      var respecConfig = {
          specStatus:           "ED",
          shortName:            "messaging",
          publishDate:          "",
          previousPublishDate:  "",
          previousMaturity:     "",
          edDraftURI:           "http://www.w3.org/2012/sysapps/messaging/",
          // lcEnd:                "",
          crEnd:                "",
          editors:  [
              { name: "Eduardo Fullea", company: "Telefonica",
                      companyURL: "http://www.tid.es/" },
              { name: "Jose M. Cantera", company: "Telefonica",
                      companyURL: "http://www.tid.es/" },
              { name: "Zoltan Kis", company: "Intel",
                      companyURL: "http://www.intel.com/" }
         ],
          inlineCSS:    true,
          noIDLIn:      true,
          noIDLSorting: true,
          extraCSS:     ["../ReSpec.js/css/respec.css"],
          wg:           "System Applications Working Group",
          wgURI:        "http://www.w3.org/2012/sysapps/",
          wgPublicList: "public-sysapps",
          wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/43696/status",
          otherLinks: [{
            key: "Repository",
            data: [{
                    value: "We are on Github.",
                    href: "https://github.com/sysapps/messaging"
                }, {
                    value: "File a bug.",
                    href: "https://github.com/sysapps/messaging/issues"
                }, {
                    value: "Commit history.",
                    href: "https://github.com/sysapps/messaging/commits/gh-pages"
                }
            ]
        }
    ]
      };
    </script>
  </head>

<!-----------------------------------------------------------------------------
Style guide to contributors:
============================
- this document uses ReSpec, see
  http://dev.w3.org/2009/dap/ReSpec.js/documentation.html
- use 80 characters wide lines, whenever possible (except long links)
- keep sections 2 empty lines apart
- put comments in front of sections, for better readability with syntax coloring
  editors
- use indentation with care: it may improve readability, but at the expense of
  line lenght
- when descriptions of attributes is short, use the <dd> elements even when
  the text also contains conformance statements (e.g. MUST, SHOULD, MAY).
  No use repeating the same information in a separate paragraph.
------------------------------------------------------------------------------>
 
  <body>

<!-- - - - - - - - - - - - - - - Abstract  - - - - - - - - - - - - - - - - - -->    
<section id="abstract">
  This specification defines a System Level API which offers a simple interface
  to get access to mobile messaging services. A typical use case of the
  Messaging API is the implementation of a messaging client application that
  allows the user to send SMS and MMS messages as well as to access and manage
  the received SMS and MMS messages.
</section>

<!-- - - - - - - - - - - - - - - Status of this document - - - - - - - - - - -->   
<section id="sotd">
</section>
    
<!-- - - - - - - - - - - - - - - Introduction  - - - - - - - - - - - - - - - -->
<section class="informative">
  <h2>Introduction</h2>
  <p>
    The Messaging API provides operations to get access to the primitives
    offered by mobile messaging services (send, receive) as well as those that
    allow to manage a mobile messaging client inbox (delete, store, mark as
    read)
  <p>
    An example of use is provided below:
  
  <pre class="example highlight">
navigator.messaging.sms.send ( '+1234567890', 'How are you?').done(
  function(message) { window.console.log('Message with identifier  ' +
                      message.messageID + ' sent at ' + message.timestamp); },
  function(error) {   window.console.error('Error: ' + error); } )
  </pre>
</section>
    
<!-- - - - - - - - - - - - - - - Conformance - - - - - - - - - - - - - - - - -->
<section id="conformance">
  <p>This specification defines conformance criteria that apply to a single
  product: the <dfn>user agent</dfn> that implements the interfaces that it
  contains.
  
  <p>Implementations that use ECMAScript to implement the APIs defined in this
  specification MUST implement them in a manner consistent with the ECMAScript
  Bindings defined in the Web IDL specification [[!WEBIDL]], as this
  specification uses that specification and terminology.
</section>
    
<!-- - - - - - - - - - - - - - - Terminology  - - - - - - - - - - - - - - - -->
<section>
  <h2>Terminology</h2> <p>The <code><a
  href="http://dev.w3.org/html5/spec/webappapis.html#eventhandler">
  EventHandler</a></code> interface represents a callback used for event
  handlers as defined in [[!HTML5]].
  
  <p>The concepts <dfn><a
  href="http://dev.w3.org/html5/spec/webappapis.html#queue-a-task"> queue a
  task</a></dfn> and <dfn><a
  href="http://dev.w3.org/html5/spec/webappapis.html#fire-a-simple-event">
  fire an event</a></dfn> are defined in [[!HTML5]].
  
  <p>The terms <a
  href="http://dev.w3.org/html5/spec/webappapis.html#event-handlers"><dfn
  id="dfn-eventhandler">event handler</dfn></a> and <a
  href="http://dev.w3.org/html5/spec/webappapis.html#event-handler-event-type">
  <dfn id="dfn-eventtypes"> event handler event types</dfn></a> are defined in
  [[!HTML5]].
  
  <p>The <dfn><a href="http://dom.spec.whatwg.org/#promise">Promise</a></dfn>
  interface, the concepts of a <a href=
  "http://dom.spec.whatwg.org/#concept-resolver"><dfn>resolver</dfn></a>, a <dfn
  id="dfn-fulfill-algorithm"><a
  href="http://dom.spec.whatwg.org/#concept-resolver-fulfill"> resolver's
  fulfill algorithm</a></dfn> and a <dfn id="dfn-reject-algorithm"><a
  href="http://dom.spec.whatwg.org/#concept-resolver-reject"> resolver's reject
  algorithm</a></dfn> are defined in [[DOM4]].</p>
  
</section>

<!-- - - - - - - - - - - - - - - Security and privacy  - - - - - - - - - - - -->
<section>
      <h2>Security and privacy considerations</h2>
      <p>This API must be only exposed to trusted content
</section>

<!-- - - - - - - - - - - - - Extended interface Navigator  - - - - - - - - - -->
<section>
  <h2><a>Navigator</a> Interface</h2>
    <dl title="partial interface Navigator" class="idl">
      <dt>readonly attribute Messaging messaging</dt>
      <dd>
      The object that exposes the interface to mobile messaging services.
      </dd>
  </dl>
</section>
    
<!-- - - - - - - - - - - - - Interface MessagingManager  - - - - - - - - - - -->
<section>
  <h2><a>MessagingManager</a> Interface</h2>
  
  <p>The <a>MessagingManager</a> interface
  represents the initial entry point for getting access to the mobile messaging
  services, i.e. SMS and MMS.
  
  <dl title="interface MessagingManager" class="idl">

    <dt>readonly attribute SmsManager sms</dt> <dd>Provides access to the
    SMS service's specific functionality.</dd>
  
    <dt>readonly attribute MmsManager mms</dt> <dd>Provides access to the
    MMS service's specific functionality.</dd>
  
    <dt> Promise findMessages ()</dt> <dd>This method makes a request
    to retrieve the messages matching the filter described by the
    <code>filter</code> parameter and according to the filtering options
    described in the <code>options</code>. It returns a new
    <code>Promise</code> that will be used to notify the caller about
    the result of the operation, which is a MessagingCursor to access the set of
    messages.
      <dl class='parameters'>
         <dt>MessagingFilter filter</dt> <dd>
           Filter that identifies the set of messages that are requested to
           be retrieved
         </dd> <dt>FilterOptions options</dt> <dd>
          Indicates the filtering options (i.e. sorting criteria, sorting
          order, limit of results).
         </dd>
     </dl>
    </dd>

    <dt> Promise findConversations ()</dt> <dd>This method makes a
    request to retrieve the list of conversations in which the messages can be
    grouped using the criteria defined by the <code>groupBy</code> parameter.
    Only those messages matching the filter described in the <code>filter</code>
    parameter SHALL be included in the resulting conversations, what can be
    useful for instance to filter just a specific type of messages (e.g. SMS) or
    to implement message search in a conversational messaging client. It returns
    a new <code>Promise</code> that will be used to notify the caller
    about the result of the operation, which is a MessagingCursor to access the
    set of conversations.
      <dl class='parameters'>
         <dt>DOMString groupBy</dt> <dd>
          Indicates the criteria used to define the conversations. It may have
          the values 'participants' if a conversation is to be defined as the
          set of messages exchanged among the same set of parties, and 'subject'
          if a conversation is to be defined as the set of messages with the
          same subject.
         </dd> <dt>MessagingFilter filter</dt> <dd>
          Filter that identifies the set of messages that are requested to be
          included in the resulting conversations.
         </dd> <dt>FilterOptions options</dt> <dd>
          Indicates the filtering options (i.e. sorting criteria, sorting order,
          limit of results) to be aplied when filtering the messages to be
          included in each of the resulting conversations.
         </dd>
     </dl>
    </dd>

    <dt> Promise getMessage ()</dt> <dd>This method makes a request to
    retrieve the message identified by the <code>messageID</code> parameter.
    It returns a new <code>Promise</code> object which allows the
    caller to be notified about the result of the operation.
      <dl class='parameters'>
         <dt>DOMString messageID</dt> <dd>
           Identifier of the message that is requested to be retrieved
         </dd>
     </dl>
    </dd>

    <dt> Promise deleteMessage ()</dt> <dd>This method requests the
    deletion of the message with identifier equal to the <code>messageID</code>
    parameter. A new <code>Promise</code> is returned in order to
    notify the request result (success or error) to the caller.
      <dl class='parameters'>
         <dt>DOMString messageID</dt> <dd>
           Identifier of the message that is requested to be deleted
         </dd>
     </dl>
    </dd>

    <dt> Promise deleteConversation ()</dt> <dd>This method requests
    the deletion of all the messages in the conversation with identifier equal
    to the <code>conversationID</code> parameter. A new <code>Promise</code> is
    returned in order to notify the request result (success or error) to the
    caller.
      <dl class='parameters'>
         <dt>DOMString conversationID</dt> <dd>
           Identifier of the conversation whose messages are requested to
           be deleted
         </dd>
     </dl>
    </dd>

    <dt> Promise markMessageRead ()</dt> <dd>This method requests to
    mark as read or unread the message with identifier equal to the
    <code>messageID</code> parameter. The method returns a new
    <code>Promise</code> that will allow the caller to be notified
    about the result (success, error) of the operation.
      <dl class='parameters'>
         <dt>DOMString messageID</dt> <dd>
           Identifier of the message that is requested to be marked as
           read or unread
         </dd>
         <dt>optional boolean value = true</dt>
         <dd>
          Indicates whether the message is to be marked as read ('true',
          which is the default) or unread ('false')
         </dd>
     </dl>
    </dd>

    <dt> Promise markConversationRead ()</dt> <dd>This method requests to mark
    as read or unread all the messages in the conversation with identifier equal
    to the <code>conversationID</code> parameter. The method returns a new
    <code>Promise</code> that will allow the caller to be notified about the
    result (success, error) of the operation.
      <dl class='parameters'>
         <dt>DOMString conversationID</dt> <dd>
           Identifier of the conversation whose messages are requested to be
           marked as read or unread
         </dd>
         <dt>optional boolean value = true</dt>
         <dd>
          Indicates whether the messages in the conversation are to be marked as
          read ('true', which is the default) or unread ('false')
         </dd>
     </dl>
    </dd>

  </dl>
   
  <section>
  <h3>Steps</h3>
  <p> The <dfn><code>findMessages</code></dfn>
  method when invoked MUST run the following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Make a request to the system to get the message(s) matching the filter
     included in the <code>filter</code> parameter and according to the
     filtering options described in the <code>options</code> parameter.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Let <var>messagingCursor</var> be a new <code>MessagingCursor</code>
      object providing access to the results of the retrieval, i.e. the set of
      <code>SmsMessage</code> and/or <code>MmsMessage</code> elements.
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>messagingCursor</em> as the <code>value</code> argument.
    </ol>
   </ol>
     
  <p> The <dfn><code>findConversations</code></dfn> method when invoked MUST
  run the following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Make a request to the system to get the set of conversations in which
     the messages can be grouped, according to the set of participants or the
     subject as indicated in the <code>groupBy</code> parameter, and filtering
     the messages included in those conversations according to the filter
     included in the <code>filter</code> parameter and the filtering options
     described in the <code>options</code> parameter.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Let <var>messagingCursor</var> be a new <code>MessagingCursor</code>
      object providing access to the results of the retrieval, i.e. the set of
      <code>Conversation</code> elements.
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>messagingCursor</em> as the <code>value</code> argument.
      </ol>
   </ol>
     
  <p> The <dfn><code>getMessage</code></dfn> method when invoked MUST run
  the following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Make a request to the system to get the message with identifier equal
     to the <code>messageID</code> parameter passed in the request.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Let <var>message</var> be the <code>SmsMessage</code> or
      <code>MmsMessage</code> whose identifier matches the
      <code>messageID</code> parameter.
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>message</em> as the <code>value</code> argument.
    </ol>
   </ol>

  <p> The <dfn><code>deleteMessage</code></dfn> method when invoked MUST run the
  following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Make a request to the system to delete the message with identifier
     equal to the <code>messageID</code> parameter passed in the request.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Let <var>messageID</var> be the <code>messageID</code> parameter
      passed in the request
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>messageID</em> as the <code>value</code> argument.
    </ol>
   </ol>

  <p> The <dfn><code>deleteConversation</code></dfn> method when invoked MUST
  run the following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Make a request to the system to delete the messages in the conversation
     with identifier equal to the <code>conversationID</code> parameter passed
     in the request.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Let <var>conversationID</var> be the <code>conversationID</code>
      parameter passed in the request
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>conversationID</em> as the <code>value</code> argument.
    </ol>
   </ol>

  <p> The <dfn><code>markMessageRead</code></dfn> method when invoked MUST run
  the following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Make a request to the system to mark as read/unread (depending on the
     <code>value</code> parameter being respectively 'true' or 'false') the
     message with identifier equal to the <code>messageID</code> parameter
     passed in the request.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Let <var>messageID</var> be the <code>messageID</code> parameter
      passed in the request
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>messageID</em> as the <code>value</code> argument.
    </ol>
   </ol>

  <p> The <dfn><code>markConversationRead</code></dfn> method when invoked
  MUST run the following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Make a request to the system to mark as read/unread (depending on the
     <code>value</code> parameter being respectively 'true' or 'false') the
     messages in the conversation with identifier equal to the
     <code>conversationID</code> parameter passed in the request.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Let <var>conversationID</var> be the <code>conversationID</code>
      parameter passed in the request
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>conversationID</em> as the <code>value</code> argument.
    </ol>
   </ol>

  <div class='note'>
  It is FFS whether the methods deleteMessage() and markMessageRead() should
  also accept an array of message identifiers as input parameter.
  </div>
   
  </section>
</section>


<!-- - - - - - - - - - - - Interface SmsManager  - - - - - - - - - - - - - - -->
<section>
  <h2><a>SmsManager</a> Interface</h2>
  <p>The <a>SmsManager</a> interface represents the SMS messaging service
  manager.
  
  <dl title="interface SmsManager : EventTarget"
  class="idl">

    <dt>readonly attribute MessageType type</dt> <dd>MUST return the type of the
    messaging service manager. It can have the following values: 'sms' or
    'mms'.</dd>
  
    <dt>readonly attribute DOMString[] serviceIDs</dt> <dd>MUST return the
    identifier of the different services for this type of messaging service
    (e.g. 'sms_sim1').</dd>

    <dt> SmsSegmentInfo segmentInfo ()</dt>
    <dd>This method returns an <code>SmsSegmentInfo</code> object including
    information on the number of concatenated SMS segments needed to send the
    text in the <code>text</code> parameter, the number of characters available
    per segment and the maximum number of available characters in the last
    segment.
      <dl class='parameters'>
         <dt>DOMString text</dt>
         <dd>
           Text intended to be sent as an SMS, whose segmentation
           information is checked by this method.
         </dd>
         <dt>optional DOMString serviceID</dt>
         <dd>
           Identifier of the service through which the message is would  be sent.
         </dd>
     </dl>
    </dd>
    
    <dt> Promise send ()</dt>
    <dd>This method issues a request to the messaging system to send an SMS
    message with the text of the <code>text</code> parameter to the destination
    number indicated in the <code>to</code> parameter.
    A <code>Promise</code> object will be returned in order to notify
    the result of the request.
      <dl class='parameters'>
         <dt>DOMString to</dt>
         <dd>
           Destination number for the SMS message.
         </dd>
         <dt>DOMString text</dt>
         <dd>
           Content of the SMS message to be sent.
         </dd>
         <dt>optional DOMString serviceID</dt>
         <dd>
           Identifier of the service through which the message is requested to
           be sent.
         </dd>
     </dl>
    </dd>

    <dt>Promise clear ()</dt>
    <dd>This method makes a request to delete all the messages associated to the
    messaging service passed as parameter.
      <dl class='parameters'>
         <dt>DOMString serviceID</dt>
         <dd>
           Identifies the messaging service all whose messages are requested to
           be deleted.
         </dd>
     </dl>
    </dd>

    <dt class="no-docs">
      attribute EventHandler onreceived
    </dt>
    <dd>Handles the <code>received</code> event of type <a>MessagingEvent</a>,
    fired when a new message is received on this messaging service manager.</dd>

    <dt class="no-docs">
      attribute EventHandler onsent
    </dt>
    <dd>Handles the <code>sent</code> event of type <a>MessagingEvent</a>, fired
    when a new message is sent using this messaging service manager.</dd>
    
    <dt class="no-docs">
      attribute EventHandler ondeliverysuccess
    </dt>
    <dd>Handles the <code>deliverysuccess</code> event of type
    <a>DeliveryReportEvent</a>, fired when a new succesful delivery
    report is received on this messaging service manager.</dd>

    <dt class="no-docs">
      attribute EventHandler ondeliveryfailure
    </dt>
    <dd>Handles the <code>deliveryfailure</code> event of type
    <a>DeliveryReportEvent</a>, fired when a new failure delivery
    report is received on this messaging service manager.</dd>

    <dt class="no-docs">
      attribute EventHandler onserviceadded
    </dt>
    <dd>Handles the <code>serviceadded</code> event of type
    <a>ServiceChangeEvent</a>, fired whenever a new messaging service is enabled
    on this messaging service manager.</dd>

    <dt class="no-docs">
      attribute EventHandler onserviceremoved
    </dt>
    <dd>Handles the <code>serviceremoved</code> event of type
    <a>ServiceChangeEvent</a>, fired when an existing messaging service is
    disabled on this messaging service manager.</dd>

   </dl>
  
  <section>
  <h3>Steps</h3>
  
  <p> The <dfn><code>send</code></dfn> method when invoked MUST run the
  following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Let <var>smsMessage</var> be a new instance of <code>SmsMessage</code>:
     <ol>
      <li>Generate a identifier for this message that is globally unique within
      the implementation, i.e. there cannot be any other message with the same
      identifier.
      <li>Set the <code>messageID</code> of <em>smsMessage</em> to the
      generated identifier.
      <li>Set the <code>type</code> of <em>smsMessage</em> to 'sms'.
      <li>Set the <code>serviceID</code> of <em>smsMessage</em> to the
      identifier of the service used to send the message, i.e. the one passed in
      the <code>serviceID</code> parameter, if provided, or otherwise to the
      first item in the <code>serviceIDs</code> attribute of the
      <code>SmsManager</code>.
      <li>Set the <code>from</code> of <em>smsMessage</em> to the number of the
      mobile subscription used to send this SMS message.
      <li>Set the <code>read</code> of <em>smsMessage</em> to 'true'.
      <li>Set the <code>to</code> of <em>smsMessage</em> to the value of the
      <code>to</code> parameter.
      <li>Set the <code>body</code> of <em>smsMessage</em> to the value of the
      <code>text</code> parameter.
      <li>Set the <code>messageClass</code> of <em>smsMessage</em> to 'class1'.
      <li>Set the <code>state</code> of <em>smsMessage</em> to 'sending'.
      <li>Set the <code>deliveryStatus</code> of <em>smsMessage</em> to
      'pending' if a delivery report has been requested or to 'not-applicable'
      otherwise.
      <li>Make a request to the system to send an SMS message with text passed
      in the <code>text</code> parameter to the number of the recipient
      indicated in the <code>to</code> parameter, using the proper service as
      described above.
      <li><a>Queue a task</a> to monitor SMS submission process.
     </ol>
     <li>If an <var>error</var> occurs run these substeps and terminate these
     steps
      <ol>
        <li>If a delivery report had been requested set the
        <code>deliveryStatus</code> of <em>smsMessage</em> to 'error'.
        <li>invoke <em>resolver</em>'s <a class="internalDFN"
        href="#dfn-reject-algorithm">reject algorithm</a> with <em>error</em> as
        the <code>value</code> argument.
     </ol>
     <li>When the request has been successfully completed:
     <ol>
      <li>Set the <code>state</code> of <em>smsMessage</em> to 'sent'.
      <li>Set the <code>timestamp</code> of <em>smsMessage</em> to the
      device's date when the SMS message was sent, i.e. when the SMS-SUBMIT
      Protocol Data Unit was sent.
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>smsMessage</em> as the <code>value</code> argument.
      <li><a>Queue a task</a> to <a>fire an event</a> named <code>sent</code>
      with the <code>message</code> attribute set to <em>smsMessage</em>.
    </ol>
   </ol>

  <p> The <dfn><code>segmentInfo</code></dfn> method when invoked MUST
  return a <code>SmsSegmentInfo</code> object that contains the following
  elements:
    <ol>
     <li>A <code>segments</code> element indicating the number of concatenated
     SMS segments needed to send the text passed in the <code>text</code>
     parameter using the service with identifier equal to the one passed in the
     <code>serviceID</code> parameter, if provided, or otherwise to the first
     item in the <code>serviceIDs</code> attribute of the
     <code>SmsManager</code>. Note that the application SHOULD NOT split the
     text in a set of strings that fit each into a single SMS segment as it
     would result in different independent SMS messages being sent, but SHOULD
     instead send the full message in a single <code>sendSMS</code> request.
     However having information on the number of SMS segments may be required by
     the application in order to inform the user (e.g. in case the length of the
     text impacts on the price charged for sending the message).
     <li>A <code>charsPerSegment</code> element indicating the number of
     characters available per SMS segment. This number depends on the encoding
     to be used to send the SMS message, which in turn depends on the language /
     special characters included in the text. 
     <li>A <code>charsAvailableInLastSegment</code> element indicating the
     maximum number of available characters in the last segment that would be
     needed to send the input string. This provides useful information to the user
     on the number of characters that can type without requiring an additional
     SMS segment to send the text.
   </ol>

  <p>Upon a new SMS message being received, the <a>user agent</a> MUST:
    <ol>
      <li>Let <var>smsMessage</var> be a new instance of <code>SmsMessage</code>.
      <li>Generate a identifier for this message that is globally unique within
      the implementation, i.e. there cannot be any other message with the same
      identifier.
      <li>Set the <code>messageID</code> of <em>smsMessage</em> to the
      generated identifier.
      <li>Set the <code>type</code> of <em>smsMessage</em> to 'sms'.
      <li>Set the <code>serviceID</code> of <em>smsMessage</em> to the
      identifier of the service at which the message has been received.
      <li>Set the <code>from</code> of <em>smsMessage</em> to the
      sender of the SMS message, i.e. the value of the TP Originating Address
      (TP-OA) field of the SMS message [[!GSM-SMS]].
      <li>Set the <code>timestamp</code> of <em>smsMessage</em> to the
      timestamp of the SMS message, i.e. the value of the
      TP-Service-Centre-Time-Stamp (TP-SCTS) parameter received in the SMS
      DELIVER Protocol Data Unit [[!GSM-SMS]].
      <li>Set the <code>read</code> of <em>smsMessage</em> to 'false'.
      <li>Set the <code>to</code> of <em>smsMessage</em> to the recipient of the
      SMS message, i.e. the value of the TP Destination Address (TP-DA) field of
      the SMS message [[!GSM-SMS]].
      <li>Set the <code>messageClass</code> of <em>smsMessage</em> to the
      message class indicated in the TP-Data-Coding-Scheme (TP-DCS) field of the
      SMS message [[!GSM-SMS]].
      <li>Set the <code>body</code> element to the text of the received SMS
      message, i.e. the value of the SM element contained within the TP User
      Data (TP-UD) field of the SMS message [[!GSM-SMS]].
      <li>Set the <code>state</code> of <em>smsMessage</em> to
      'received'.
      <li>Set the <code>deliveryStatus</code> of <em>smsMessage</em> to
      'not-applicable'.
      <li><a>Queue a task</a> to <a>fire an event</a> named
      <code><a>received</a></code> with the <code>message</code> attribute set
      to <em>smsMessage</em>.
      <li><a>Queue a task</a> to fire a system message named
      <code>received</code> of type <code><a>ReceivedMessage</a></code> with the
      <code>message</code> attribute set to <em>smsMessage</em>.
    </ol>

  <p>Upon a delivery report of a previously sent SMS message being received, the
  <a>user agent</a> MUST
    <ol>
      <li>Let <var>smsMessage</var> be the instance of <code>SmsMessage</code>
      to which this delivery report is related.
      <li>Set the <code>deliveryStatus</code> parameter of <em>smsMessage</em>
      to 'success' or 'error' depending on the reported
      result.
      <li>Set the <code>deliveryTimestamp</code> of <em>smsMessage</em>
      to the delivery time of the SMS message, i.e. the TP-Discharge-Time (TP
      DT) parameter included in the SMS-STATUS-REPORT Protocol Data Unit
      [[!GSM-SMS]].
      <li><a>Queue a task</a> to <a>fire an event</a> named
      <a>deliverysuccess</a> or <a>deliveryfailure</a> respectively if the
      delivery was successfull or not, with
        <ol>
          <li>the <code>messageID</code> attribute set to the
          <code>messageID</code> attribute of <em>smsMessage</em>,
          <li>the <code>serviceID</code> attribute set to the
          <code>serviceID</code> attribute of <em>smsMessage</em>,
          <li>the first item in the <code>recipients</code> attribute set to the
          <code>to</code> attribute of <em>smsMessage</em>, and
          <li>the first item in the <code>deliveryTimestamps</code> attribute set
          to delivery time of such message.
        </ol>
      <li><a>Queue a task</a> to fire a system message of type
      <code><a>DeliveryReport</a></code>named <a>deliverysuccess</a> or
      <a>deliveryfailure</a> respectively if the delivery was successfull or
      not, with
        <ol>
          <li>the <code>messageID</code> attribute set to the
          <code>messageID</code> attribute of <em>smsMessage</em>,
          <li>the <code>serviceID</code> attribute set to the
          <code>serviceID</code> attribute of <em>smsMessage</em>, and
          <li>the first item in the <code>recipients</code> attribute set to the
          <code>to</code> attribute of <em>smsMessage</em>.
          <li>the first item in the <code>deliveryTimestamps</code> attribute set
          to delivery time of such message.
        </ol>
    </ol>
  
  <p> The <dfn><code>clear</code></dfn> method when invoked MUST run the
  following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Make a request to the system to delete all the messages associated to
     the messaging service with identifier equal to the <code>serviceID</code>
     parameter.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Let <var>serviceID</var> be the <code>serviceID</code> parameter
      passed in the request
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>serviceID</em> as the <code>value</code> argument.
    </ol>
   </ol>
  </section>
 
  <section>
    <h2>Event handlers</h2>
    <p>The following are the <a class="internalDFN"
    href="#dfn-eventhandler">event handlers</a> (and their corresponding <a
    class="internalDFN" href="#dfn-eventtypes">event types</a>) that MUST be
    supported as attributes by the <a>SmsManager</a> object.
    
    <table class="simple">
      <thead>
        <tr>
          <th>event handler</th>
          <th>event name</th>
          <th>event type</th>
          <th>short description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong><code>onreceived</code></strong></td>
          <td><code><dfn>received</dfn></code></td>
          <td><a><code>MessagingEvent</code></a></td>
          <td>handles received messages</td>
        </tr>
        <tr>
          <td><strong><code>onsent</code></strong></td>
          <td><code><dfn>sent</dfn></code></td>
          <td><a><code>MessagingEvent</code></a></td>
          <td>handles sent messages</td>
        </tr>
        <tr>
          <td><strong><code>ondeliverysuccess</code></strong></td>
          <td><code><dfn>deliverysuccess</dfn></code></td>
          <td><a><code>DeliveryReportEvent</code></a></td>
          <td>handles successful delivery reports</td>
        </tr>
        <tr>
          <td><strong><code>ondeliveryfailure</code></strong></td>
          <td><code><dfn>deliveryfailure</dfn></code></td>
          <td><a><code>DeliveryReportEvent</code></a></td>
          <td>handles failure delivery reports</td>
        </tr>
        <tr>
          <td><strong><code>onserviceadded</code></strong></td>
          <td><code><dfn>serviceadded</dfn></code></td>
          <td><a><code>ServiceChangeEvent</code></a></td>
          <td>handle new messaging services</td>
          </td>
        </tr>
        <tr>
          <td><strong><code>onserviceremoved</code></strong></td>
          <td><code><dfn>serviceremoved</dfn></code></td>
          <td><a><code>ServiceChangeEvent</code></a></td>
          <td>handle disabled messaging services</td>
          </td>
        </tr>
      </tbody>
    </table>
  </section>
  
</section>


<!-- - - - - - - - - - - - Interface SmsSegmentInfo  - - - - - - - - - - - - -->
<section>
  <h2><a>SmsSegmentInfo</a> Dictionary</h2>
  <p>The <a>SmsSegmentInfo</a> dictionary contains information about the
  segmentation of a given text to be sent as SMS.
  <dl title="dictionary SmsSegmentInfo"
      class="idl">
    <dt>long segments</dt>
    <dd>MUST return the total number of SMS segments needed to send the input
    string, taking into account the encoding to be used to send such message as
    well as the overhead associated to concatenated SMS messages.</dd>

    <dt>long charsPerSegment</dt>
    <dd>MUST return the number of characters available per SMS segment as per
    the encoding to be used to send the SMS message. In case the variable length
     encoding, the value of this element MUST be calculated asumming the minimum
     length for all the characters.</dd>

    <dt>long charsAvailableInLastSegment</dt>
    <dd>MUST return the maximum number of available characters in the last
    segment needed to send the input string. In case the variable length
    encoding, the value of this element MUST be calculated asumming the minimum
    length for all the remaining characters.</dd>

  </dl>
</section>    
    

<!-- - - - - - - - - - - - Interface MmsManager  - - - - - - - - - - - - - - -->   
<section>
  <h2><a>MmsManager</a> Interface</h2>
  <p>The <a>MmsManager</a> interface represents the MMS messaging service
  manager.
  
  <dl title="interface MmsManager : EventTarget"
  class="idl">

    <dt>readonly attribute MessageType type</dt> <dd>MUST return the type of the
    messaging service manager. It can have the following values: 'sms' or
    'mms'.</dd>
  
    <dt>readonly attribute DOMString[] serviceIDs</dt> <dd>MUST return the
    identifier of the different services for this type of messaging service
    (e.g. 'sms_sim1').</dd>

    <dt>FetchMode getFetchMode ()</dt>
    <dd>This method requests to retrieve the fetch mode associated to a specific
    service (the one identified by the <code>serviceID</code> parameter, if
    provided, or the first item in the <code>serviceIDs</code> attribute of
    the <code>MmsManager</code> otherwise).
    <dl class='parameters'>
         <dt>optional DOMString serviceID</dt>
         <dd>
           Identifier of the service whose fetch mode is queried.
         </dd>
     </dl>
    </dd>

    <dt>void setFetchMode ()</dt>
    <dd>This method issues a request to the messaging system to set the MMS
    message fetch mode for the service identified by the <code>serviceID</code>
    parameter, if provided, or for all services otherwise, to the mode indicated
    in the <code>fetchMode</code> parameter.
    <dl class='parameters'>
         <dt>FetchMode fetchMode</dt>
         <dd>
           Fetch mode that is requested to be set for a specific service.
         </dd>
         <dt>optional DOMString serviceID</dt>
         <dd>
           Identifier of the service whose fetch mode is requested to be set.
         </dd>
     </dl>
    </dd>
   
    <dt> Promise send ()</dt>
    <dd>This method issues a request to the messaging system to send an MMS
    message with the content and recipients included in the
    <code>mmsContent</code> parameter.
    A <code>Promise</code> object will be returned in order to notify the result
    of the request.
    <dl class='parameters'>
         <dt>MmsContent mmsContent</dt>
         <dd>
           Content and recipients of the MMS message to be sent.
         </dd>
         <dt>optional DOMString serviceID</dt>
         <dd>
           Identifier of the service through which the message is requested to
           be sent.
         </dd>
     </dl>
    </dd>

    <dt> Promise fetch ()</dt>
    <dd>This method requests to fetch an MMS message with identifier equal to
    the indicated in the <code>messageID</code> parameter from the URL indicated
    in the MMS notification. The method returns a new <code>Promise</code> that
    will allow the caller to be notified about the result (success, error) of
    the
    operation.
      <dl class='parameters'>
         <dt>DOMString messageID</dt>
         <dd>
           Identifier of the MMS message that is requested to be download.
         </dd>
     </dl>
    </dd>

    <dt>Promise clear ()</dt>
    <dd>This method makes a request to delete all the messages associated to the
    messaging service passed as parameter.
      <dl class='parameters'>
         <dt>DOMString serviceID</dt>
         <dd>
           Identifies the messaging service all whose messages are requested to
           be deleted.
         </dd>
     </dl>
    </dd>

    <dt class="no-docs">
      attribute EventHandler onreceived
    </dt>
    <dd>Handles the <code>received</code> event of type <a>MessagingEvent</a>,
    fired when a new message is received on this messaging service manager.</dd>

    <dt class="no-docs">
      attribute EventHandler onsent
    </dt>
    <dd>Handles the <code>sent</code> event of type <a>MessagingEvent</a>, fired
    when a new message is sent using this messaging service manager.</dd>
    
    <dt class="no-docs">
      attribute EventHandler ondeliverysuccess
    </dt>
    <dd>Handles the <code>deliverysuccess</code> event of type
    <a>DeliveryReportEvent</a>, fired when a new succesful delivery
    report is received on this messaging service manager.</dd>

    <dt class="no-docs">
      attribute EventHandler ondeliveryfailure
    </dt>
    <dd>Handles the <code>deliveryfailure</code> event of type
    <a>DeliveryReportEvent</a>, fired when a new failure delivery
    report is received on this messaging service manager.</dd>

    <dt class="no-docs">
      attribute EventHandler onserviceadded
    </dt>
    <dd>Handles the <code>serviceadded</code> event of type
    <a>ServiceChangeEvent</a>, fired whenever a new messaging service is enabled
    on this messaging service manager.</dd>

    <dt class="no-docs">
      attribute EventHandler onserviceremoved
    </dt>
    <dd>Handles the <code>serviceremoved</code> event of type
    <a>ServiceChangeEvent</a>, fired when an existing messaging service is
    disabled on this messaging service manager.</dd>
     
   </dl>  

  <div class='note'>
  It is FFS whether MMS settings (e.g. fetch mode, creation mode) needs to be
  managed through the MmsManager interface.
  </div>
   
  <section>
  <h3>Steps</h3>        
    
  <p> The <dfn><code>send</code></dfn> method when invoked MUST run the
  following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>Let <var>mmsMessage</var> be a new instance of <code>MmsMessage</code>
     and:
     <ol>
      <li>Generate a identifier for this message that is globally unique within
      the implementation, i.e. there cannot be any other message with the same
      identifier.
      <li>Set the <code>messageID</code> of <em>mmsMessage</em> to the
      generated identifier.
      <li>Set the <code>type</code> of <em>mmsMessage</em> to 'mms'.
      <li>Set the <code>serviceID</code> of <em>mmsMessage</em> to the
      identifier of the service used to send the message, i.e. the one passed in
      the <code>serviceID</code> parameter, if provided, or otherwise to the
      first item in the <code>serviceIDs</code> attribute of the
      <code>MmsManager</code>.
      <li>Set the <code>from</code> of <em>mmsMessage</em> to the number of the
      mobile subscription used to send this MMS message.
      <li>Set the <code>read</code> of <em>mmsMessage</em> to 'true'.
      <li>Set the <code>to</code> of <em>mmsMessage</em> to the <code>to</code>
      in the <code>mmsContent</code> parameter.
      <li>Set the <code>cc</code> of <em>mmsMessage</em> to the <code>cc</code>
      array in the <code>mmsContent</code> parameter.
      <li>Set the <code>bcc</code> of <em>mmsMessage</em> to the
      <code>bcc</code> array in the <code>mmsContent</code> parameter.
      <li>Set the <code>subject</code> of <em>mmsMessage</em> to the value of
      the the <code>subject</code> parameter in <code>mmsContent</code>.
      <li>Set the <code>smil</code> of <em>mmsMessage</em> to the value of the
      the <code>smil</code> parameter in <code>mmsContent</code>.
      <li>Set the <code>attachments</code> of <em>mmsMessage</em> to the value
      of the the <code>attachments</code> array in <code>mmsContent</code>
      parameter.
      <li>Set the <code>state</code> of <em>mmsMessage</em> to 'sending'.
      <li>Add a new item in the <code>deliveryInfo</code> attribute of
      <em>mmsMessage</em> for each unique recipient included in the
      <code>to</code>, <code>cc</code> and <code>bcc</code> parameters (i.e. a
      single item if the same address has multiple ocurrences across these
      parameters), with the <code>recipient</code> attribute set to this
      recipient's address and the <code>deliveryStatus</code> attribute set to
      'pending', if a delivery report has been requested, or 'not-applicable'
      otherwise.
      <li>Make a request to the system to send an MMS message with the content
      passed in the <code>content</code> parameter to the number(s) of indicated
      in the <code>to</code> parameter, using the proper service as described
      above.
      <li><a>Queue a task</a> to monitor MMS sending progress.
     </ol>
     <li>If an <var>error</var> occurs run these substeps and terminate these
     steps
      <ol>
        <li>If a delivery report had been requested set the
        <code>deliveryStatus</code> attribute of the different items in the
        <code>deliveryInfo</code> array attribute of <em>mmsMessage</em> to
        'error'.
        <li>invoke <em>resolver</em>'s <a class="internalDFN"
        href="#dfn-reject-algorithm">reject algorithm</a> with <em>error</em> as
        the <code>value</code> argument.
     </ol>
     <li>When the request has been successfully completed:
     <ol>
      <li>Set the <code>state</code> of <em>mmsMessage</em> to 'sent'.
      <li>Set the <code>timestamp</code> of <em>mmsMessage</em> to the
      device's date when the MMS message was sent, i.e. the date when the
      M-Send.req Protocol Data Unit was sent by the MMS Client.
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>mmsMessage</em> as the <code>value</code> argument.
      <li><a>Queue a task</a> to <a>fire an event</a> named
      <code>sent</code> with the <code>message</code> attribute set to
      <em>mmsMessage</em>.
     </ol>
    </ol>        

  <p>The reception of an MMS message is a two-step process: Firstly, an MMS
  notification encapsulated in a WAP Push OTA message [[OMA-PUSH]] is received
  by the device. This MMS notification contains limited information about the
  MMS message and a URL where the device can retrieve the full MMS message from.
  Secondly, the MMS message is retrieved either automatically, i.e. performed
  right after the reception of the MMS notification, or manually, i.e. invoked
  manually by the user.

  <p>Upon a new MMS notification being received, the <a>user agent</a>
  MUST:
    <ol>
      <li>Let <var>mmsMessage</var> be a new instance of <code>MmsMessage</code>.
      <li>Generate a identifier for this message that is globally unique within
      the implementation, i.e. there cannot be any other message with the same
      identifier.
      <li>Set the <code>messageID</code> of <em>mmsMessage</em> to the
      generated identifier.
      <li>Set the <code>type</code> of <em>mmsMessage</em> to 'mms'.
      <li>Set the <code>serviceID</code> of <em>mmsMessage</em> to the
      identifier of the service at which the message has been received.
      <li>Set the <code>read</code> of <em>mmsMessage</em> to 'false'.
      <li>if the fetch mode is <a class="internalDFN"
      href="#idl-def-FetchMode.manual">manual</a>, <a class="internalDFN"
      href="#idl-def-FetchMode.never">never</a> or the device is not in the home
      network and the the fetch mode is <a class="internalDFN"
      href="#idl-def-FetchMode.automatic-home">automatic-home</a>: 
        <ol>
          <li>Set the <code>from</code> of <em>mmsMessage</em> to the
          value of the 'From' field of the MMS notification, if present.
          <li>Set the <code>timestamp</code> of <em>mmsMessage</em> to
          the timestamp of the binary SMS message used to transport the MMS
          notification, i.e. the value of the TP-Service-Centre-Time-Stamp
          (TP-SCTS) parameter received in the SMS-DELIVER Protocol Data Unit
          [[!GSM-SMS]].
          <li>Set the <code>expiry</code> of <em>mmsMessage</em> to the value of
          the 'X-Mms-Expiry' field of the MMS notification.
          <li>Add a new item in the <code>to</code> array of <em>mmsMessage</em>
          for each of recipients in the 'To' field of the MMS notification
          [[!MMS13]], if present.
          <li>Add a new item in the <code>cc</code> array of <em>mmsMessage</em>
          for each of recipients in the 'Cc' field of the MMS notification
          [[!MMS13]], if present.
          <li>Add a new item in the <code>bcc</code> array of
          <em>mmsMessage</em> for each of recipients in the 'Bcc' field of the
          MMS notification [[!MMS13]], if present.
          <li>Set the <code>subject</code> attribute to the value of the 'Subject'
          field of the MMS notification [[!MMS13]], if present.
          <li>Set the <code>state</code> of <em>mmsMessage</em> to
          'not-downloaded'.
        </ol>
      <li>if the fetch mode is otherwise <a class="internalDFN"
      href="#idl-def-FetchMode.automatic">automatic</a> or the device is in the
      home network and the the fetch mode is <a class="internalDFN"
      href="#idl-def-FetchMode.automatic-home">automatic-home</a>: 
        <ol>
          <li>Make a request to the system to fetch the MMS message from the URL
          indicated in the X-Mms-Content-Location field of the MMS notification.
          Once the MMS has been fetched continue with following steps.
          <li>Run the <dfn id="dfn-fill-mms-message">steps for filling the
          <code>MmsMessage</code> object with the data contained in the MMS
          message enclosed in the M-Retrieve.conf Protocol Data Unit</dfn>.  
          <ol>
              <li>Set the <code>from</code> of <em>mmsMessage</em> to the
              value of the 'From' field of the MMS message [[!MMS13]].
              <li>Set the <code>timestamp</code> of <em>mmsMessage</em> to
              the value of the 'Date' field of the MMS message [[!MMS13]].
              <li>Add a new item in the <code>to</code> array of
              <em>mmsMessage</em> for each of recipients in the 'To' field of
              the MMS message [[!MMS13]], if present.
              <li>Add a new item in the <code>cc</code> array of
              <em>mmsMessage</em> for each of recipients in the 'Cc' field of
              the MMS message [[!MMS13]], if present.
              <li>Add a new item in the <code>bcc</code> array of
              <em>mmsMessage</em> for each of recipients in the 'Bcc' field of
              the MMS message [[!MMS13]], if present.
              <li>Set the <code>subject</code> attribute to the value of the 'Subject'
              field of the MMS message [[!MMS13]], if present.
              <li>Set the <code>smil</code> attribute to a <code>DOMString</code>
              containing the SMIL object of the received MMS message [[!MMS13]],
              if present.
              <li>For each of the media files attached to the received MMS message add a
              new item to the <code>attachments</code> array with:
              <ol>
                <li>A new <code>Blob</code> object including the actual content
                of the attachment and the media type. The charset encoding
                is indicated as part of the <code>type</code> attribute of the
                <code>Blob</code> object by means of appending a
                <code>charset</code> parameter after the media type as
                explained in [[!RFC2046]], e.g. "text/plain; charset=utf-8".
                <li>The <code>contentID</code> attribute filled with the Content-ID used
                to reference this attachment from the SMIL object in the incoming MMS
                message [[!MMS13]], if present.
                <li>The <code>contentLocation</code> attribute filled with the
                Content-Location used to reference this attachment from the SMIL object in
                the incoming MMS message [[!MMS13]], if present.
              </ol>
          </ol>
          <li>Set the <code>state</code> of <em>mmsMessage</em> to
          'received'.
          <li>Add a new item in the <code>deliveryInfo</code> array attribute of
          <em>mmsMessage</em> for each unique recipient included in the
          'To', 'Cc' and 'Bcc' fields (i.e. a single item if the same address
          has multiple ocurrences across these parameters), with the
          <code>recipient</code> attribute set to this recipient's address and
          the <code>deliveryStatus</code> attribute set to 'not-applicable'.
        </ol>
      <li><a>Queue a task</a> to <a>fire an event</a> named
      <code><a>received</a></code> with the <code>message</code> attribute set
      to <em>mmsMessage</em>.
      <li><a>Queue a task</a> to fire a system message named
      <code>received</code> of type <code><a>ReceivedMessage</a></code> with the
      <code>message</code> attribute set to <em>mmsMessage</em>.
    </ol>
    </ol>    
    
   <p> The <dfn><code>fetch</code></dfn> method can be invoked to fetch an MMS
   message that has not been automatically fetched upon receiving the
   corresponding MMS notification, e.g. due to the fetch mode being <a
   class="internalDFN" href="#idl-def-FetchMode.manual">manual</a>. When this
   method is invoked the User Agent MUST run the following steps:
    <ol>
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>If the <code>messageID</code> parameter passed in the request matches
     with an MMS message that has already been fetched, or to an SMS message go
     to next step, otherwise let <var>mmsMessage</var> the message with
     <code>messageID</code> attribute equal to the <code>messageID</code>
     parameter and set the <code>state</code> of <em>mmsMessage</em> to
     'fetching' and make a request to the system to fetch the MMS message.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Run the <a class="internalDFN" href="#dfn-fill-mms-message">steps for
      filling the MmsMessage object with the data contained in the MMS
      message</a>.
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>mmsMessage</em> as the <code>value</code> argument.
    </ol>
   </ol>

  <p>
    An example of manual fetch of an MMS is provided below:
  
  <pre class="example highlight">
navigator.setMessageHandler ('received', onMessageReceived)
function onMessageReceived(message) {
  if (message.type == 'sms') { window.console.log('SMS Message from ' +
                               message.from + ' received');  } 
  else if (message.type == 'mms') {
	window.console.log('MMS Message from ' + message.from + ' received');  
	if (message.state == 'not-downloaded') { 
		 window.console.log('MMS Message download started');  
		 navigator.messaging.mms.fetch (message.id).done(
			function(message) { window.console.log('MMS Message downloaded!');},
			function(error)   { window.console.error('Error: ' + error);} );
	}
  }
}
  </pre>
   
  <div class='note'>
  It is FFS how to report the progress of the sending and fetching of an MMS
  message.
  </div>

  <p>Upon a delivery report of a previously sent MMS message being received, the
  <a>user agent</a> MUST
    <ol>
      <li>Let <var>mmsMessage</var> be the instance of <code>MmsMessage</code>
      to which this delivery report is related.
      <li>For each of the items in the <code>deliveryInfo</code> array
      attribute of <em>mmsMessage</em> whose <code>recipient</code>
      attribute matches one of the recipients of the MMS to which the delivery
      report is related,  
        <ol>
          <li>set its <code>deliveryStatus</code> attribute:
            <ol>
              <li>to 'success', in case of successful delivery, i.e. if the
              value of the X-Mms-Status element in the M-Delivery.ind Protocol
              Data Unit [[!MMS13]] is 'Retrieved', or
              <li>to 'error', in case of failed delivery, i.e. if the value of
              the X-Mms-Status element in the the M-Delivery.ind Protocol Data
              Unit [[!MMS13]] is 'Expired', 'Rejected' or 'Unreachable'.
            </ol>
          <li>set its <code>deliveryTimestamp</code> attribute to the delivery
          time, i.e. the 'Date' field in the M-Delivery.ind Protocol Data Unit
          [[!MMS13]], in case of successful delivery.
        </ol>
      <li><a>Queue a task</a> to <a>fire an event</a> named
      <a>deliverysuccess</a> or <a>deliveryfailure</a> respectively if the
      delivery was successfull or not, with
        <ol>
          <li>the <code>messageID</code> attribute set to the
          <code>messageID</code> attribute of <em>mmsMessage</em>,
          <li>the <code>serviceID</code> attribute set to the
          <code>serviceID</code> attribute of <em>mmsMessage</em>,
          <li>the <code>recipients</code> attribute set to the subset of the
          original recipients of <em>mmsMessage</em>to which this delivery
          report is related, and
          <li>in case of successful delivery, with each of the items in the
          <code>deliveryTimestamps</code> attribute set to the delivery time of
          the MMS message to the corresponding recipient, i.e. that in the
          same position of the <code>recipients</code> array.
        </ol>
      <li><a>Queue a task</a> to fire a system message of type
      <code><a>DeliveryReport</a></code>named <a>deliverysuccess</a> or
      <a>deliveryfailure</a> respectively if the delivery was successfull or
      not, with
        <ol>
          <li>the <code>messageID</code> attribute set to the
          <code>messageID</code> attribute of <em>mmsMessage</em>,
          <li>the <code>serviceID</code> attribute set to the
          <code>serviceID</code> attribute of <em>mmsMessage</em>,
          <li>the <code>recipients</code> attribute set to the subset of the
          original recipients of <em>mmsMessage</em>to which this delivery
          report is related, and
          <li>in case of successful delivery, with each of the items in the
          <code>deliveryTimestamps</code> attribute set to the delivery time of
          the MMS message to the corresponding recipient, i.e. that in the
          same position of the <code>recipients</code> array.
        </ol>
    </ol>

  <p> The <dfn><code>clear</code></dfn> method when invoked MUST run the
  following steps:
    <ol>
     <li>Make a request to the system to delete all the messages associated to
     the messaging service with identifier equal to the <code>serviceID</code>
     parameter.
     <li>Let <var>promise</var> be a new <code>Promise</code> object and
     <var>resolver</var> its associated <code>resolver</code>
     <li>Return <var>promise</var> to the caller.
     <li>If an <var>error</var> occurs invoke <em>resolver</em>'s <a
     class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a> with
     <em>error</em> as the <code>value</code> argument.
     <li>When the request has been successfully completed:
     <ol>
      <li>Let <var>serviceID</var> be the <code>serviceID</code> parameter
      passed in the request
      <li>Invoke <em>resolver</em>'s <a class="internalDFN"
      href="#dfn-fulfill-algorithm">fulfill algorithm</a> with
      <em>serviceID</em> as the <code>value</code> argument.
    </ol>
   </ol>
  </section>

  <section>
    <h2>Event handlers</h2>
    <p>The following are the <a class="internalDFN"
    href="#dfn-eventhandler">event handlers</a> (and their corresponding <a
    class="internalDFN" href="#dfn-eventtypes">event types</a>) that MUST be
    supported as attributes by the <a>MmsManager</a> object.
    
    <table class="simple">
      <thead>
        <tr>
          <th>event handler</th>
          <th>event name</th>
          <th>event type</th>
          <th>short description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong><code>onreceived</code></strong></td>
          <td><code><dfn>received</dfn></code></td>
          <td><a><code>MessagingEvent</code></a></td>
          <td>handles received messages</td>
        </tr>
        <tr>
          <td><strong><code>onsent</code></strong></td>
          <td><code><dfn>sent</dfn></code></td>
          <td><a><code>MessagingEvent</code></a></td>
          <td>handles sent messages</td>
        </tr>
        <tr>
          <td><strong><code>ondeliverysuccess</code></strong></td>
          <td><code><dfn>deliverysuccess</dfn></code></td>
          <td><a><code>DeliveryReportEvent</code></a></td>
          <td>handles successful delivery reports</td>
        </tr>
        <tr>
          <td><strong><code>ondeliveryfailure</code></strong></td>
          <td><code><dfn>deliveryfailure</dfn></code></td>
          <td><a><code>DeliveryReportEvent</code></a></td>
          <td>handles failure delivery reports</td>
        </tr>
        <tr>
          <td><strong><code>onserviceadded</code></strong></td>
          <td><code><dfn>serviceadded</dfn></code></td>
          <td><a><code>ServiceChangeEvent</code></a></td>
          <td>handle new messaging services</td>
          </td>
        </tr>
        <tr>
          <td><strong><code>onserviceremoved</code></strong></td>
          <td><code><dfn>serviceremoved</dfn></code></td>
          <td><a><code>ServiceChangeEvent</code></a></td>
          <td>handle disabled messaging services</td>
          </td>
        </tr>
      </tbody>
    </table>
  </section>

</section>    
    

<!-- - - - - - - - - - - - Interface SmsMessage  - - - - - - - - - - - - - - -->
<section>
  <h2><a>SmsMessage</a> Interface</h2>
  <p>The <a>SmsMessage</a> interface represents an SMS message as defined in
  [[!GSM-SMS]]. This interface is not intended to represent binary SMS, which
  are out of the scope of this API.
  <dl title="interface SmsMessage"
      class="idl">
    <dt>readonly attribute DOMString messageID</dt>
    <dd>MUST return the identifier of the message.</dd>

    <dt>readonly attribute MessageType type</dt>
    <dd>MUST return the type of message, i.e. 'sms'.</dd>

    <dt>readonly attribute DOMString serviceID</dt>
    <dd>MUST return the messaging service id</a> used to send / receive this
    message.</dd>

    <dt>readonly attribute DOMString from</dt>
    <dd>MUST return the sender of the message, i.e. the TP Originating Address
    (TP-OA) of the SMS message.</dd>

    <dt>readonly attribute Date timestamp</dt>
    <dd>MUST return, for received messages the time the message reached the
    Short Message Center, indicated in the TP-Service-Centre-Time-Stamp
    (TP-SCTS) parameter of the SMS message, and for sent messages the the
    device's date when the SMS message was sent, i.e. when the SMS-SUBMIT
    Protocol Data Unit was sent.</dd>

    <dt>readonly attribute boolean read</dt>
    <dd>MUST return 'true' if the message has been marked as read, or 'false'
    otherwise.</dd>

    <dt>readonly attribute DOMString to</dt>
    <dd>MUST return the recipient of the message, i.e. the TP Destination
    Address (TP-DA) of the SMS message.</dd>

    <dt>readonly attribute DOMString body</dt>
    <dd>MUST return text of the SMS message, i.e. the SM element contained
    within the TP User Data (TP-UD) field of the SMS message.</dd>

    <dt>readonly attribute SmsState state</dt>
    <dd>MUST return the status of the SMS message.</dd>

    <dt>readonly attribute DeliveryStatus deliveryStatus</dt>
    <dd>MUST return the delivery status of the SMS message.
    </dd>

    <dt>readonly attribute Date? deliveryTimestamp</dt>
    <dd>MUST return for sent messages the delivery date as reported in the
    TP-Discharge-Time (TP DT) parameter included in the SMS-STATUS-REPORT
    Protocol Data Unit or null if there is no positive knowledge about the
    delivery of the message. MUST return null for received messages.</dd>

    <dt>readonly attribute MessageClass messageClass</dt>
    <dd>MUST return the SMS message class, according to the value indicated in
    the TP-Data-Coding-Scheme (TP-DCS) field of the SMS.</dd>

  </dl>
</section>

<!-- - - - - - - - - - - - Interface MmsMessage  - - - - - - - - - - - - - - -->
<section>
  <h2><a>MmsMessage</a> Interface</h2>
  <p>The <a>MmsMessage</a> interface represents an MMS message, as defined in 
  [[!MMS13]].
  <dl title="interface MmsMessage"
      class="idl">
    <dt>readonly attribute DOMString messageID</dt>
    <dd>MUST return the identifier of the message.</dd>

    <dt>readonly attribute MessageType type</dt>
    <dd>MUST return the type of message, i.e. 'mms'.</dd>

    <dt>readonly attribute DOMString serviceID</dt>
    <dd>MUST return the messaging service id</a> used to send / receive this
    message.</dd>

    <dt>readonly attribute DOMString from</dt>
    <dd>MUST return the sender of the message, i.e. the 'From' field of the MMS
    message.</dd>

    <dt>readonly attribute Date timestamp</dt>
    <dd>MUST return, for received messages the time the message reached the
    Multimedia Messaging Service Center, i.e. the 'Date' field of the MMS
    message, for received but not downloaded messages the timestamp of the
    binary SMS message used to transport the MMS notification and for sent
    messages the device's date when the MMS message was sent, i.e. the date when
    the M-Send.req Protocol Data Unit was sent by the MMS Client.</dd>

    <dt>readonly attribute unsigned long? expiry</dt>
    <dd>MUST return the number of seconds the message will be stored in the
    Multimedia Messaging Service Center and thus available for download. This
    time is calculated since the date the MMS Notification was sent.</dd>

    <dt>readonly attribute boolean read</dt>
    <dd>MUST return 'true' if the message has been marked as read, or 'false'
    otherwise.</dd>

    <dt>readonly attribute DOMString[] to</dt>
    <dd>MUST return an array containing the recipient(s) included
    in the 'To' field of the MMS message.</dd>

    <dt>readonly attribute DOMString[] cc</dt>
    <dd>MUST return an array containing the recipient(s) included
    in the 'Cc' field of the MMS message.</dd>

    <dt>readonly attribute DOMString[] bcc</dt>
    <dd>MUST return an array containing the recipient(s) included
    in the 'Bcc' field of the MMS message.</dd>

    <dt>readonly attribute DOMString subject</dt>
    <dd>MUST return the subject of the MMS message, corresponding to the
    'Subject' field of the MMS message.</dd>

    <dt>readonly attribute DOMString smil</dt>
    <dd>MUST return the SMIL, i.e. the presentation element, unparsed as
    DOMString, that the messaging client needs to use to determine the way the
    content of the MMS message is displayed.</dd>

    <dt>readonly attribute MmsAttachment[]? attachments</dt>
    <dd>MUST return the set of attachments of the MMS message.</dd>

    <dt>readonly attribute MmsState state</dt>
    <dd>MUST return the status of the MMS message.</dd>

    <dt>readonly attribute MmsDeliveryInfo[] deliveryInfo</dt>
    <dd>MUST return an array with each of the items indicating the delivery
    status and, if applicable, the delivery time to each of the recipients of the
    message.</dd>

  </dl>
</section>

<!-- - - - - - - - - - - - Dictionary MmsContent - - - - - - - - - - - - - - -->
<section>
  <h2><a>MmsContent</a> Dictionary</h2>
  <dl title="dictionary MmsContent" class="idl">
    <dt>DOMString subject</dt>
    <dd>Indicates the subject of the MMS message, corresponding to the
    'Subject' field of the MMS message.</dd>

    <dt>DOMString[] to</dt>
    <dd>Indicates the recipient(s) included in the 'To' field of the MMS
    message.
    There MUST be at least one recipient in any of the <code>to</code>,
    <code>cc</code> or <code>bcc</code> attributes.</dd>

    <dt>DOMString[] cc</dt>
    <dd>Indicates the recipient(s) included in the 'Cc' field of the MMS
    message.
    There MUST be at least one recipient in any of the <code>to</code>,
    <code>cc</code> or <code>bcc</code> attributes.</dd>

    <dt>DOMString[] bcc</dt>
    <dd>Indicates the recipient(s) included in the 'Bcc' field of the MMS
    message. 
    There MUST be at least one recipient in any of the <code>to</code>,
    <code>cc</code> or <code>bcc</code> attributes.</dd>

    <dt>DOMString smil</dt>
    <dd>Contains the SMIL component, i.e. the presentation element that
    determines the way the content of the MMS message MUST be displayed.</dd>

    <dt>MmsAttachment[] attachments</dt>
    <dd>Contains the set of attachments of the MMS message.</dd>
  </dl>    
</section>

    
<!-- - - - - - - - - - - - Dictionary MmsAttachment  - - - - - - - - - - - - -->
<section>
  <h2><a>MmsAttachment</a> Dictionary</h2>
  <dl title="dictionary MmsAttachment" class="idl">
    <dt>DOMString contentID</dt>
    <dd>
    The Content-ID parameter that MAY be used to refer to the attachment from
    the SMIL presentation object as described in [[!MMS13]] and [[!MIME-ENC]].
    At least one of contentID and contentLocation MUST be specified if the
    MMS Message contains an SMIL presentation object. 
    </dd>
    <dt>DOMString contentLocation</dt>
    <dd>
    The Content-Location parameter that MAY be used to refer to the attachment
    from the SMIL presentation object as described in [[!MMS13]] and
    [[!MIME-ENC]]. At least one of contentID and contentLocation MUST be
    specified if the MMS Message contains an SMIL presentation object. It may
    also be used as a hint to define the filename when the attachment is stored
    at the file system.
    </dd>
    <dt>Blob content</dt>
    <dd>
    The Blob object containing the media type and the content of the attachment.
    </dd>
  </dl>    
</section>
    
<!-- - - - - - - - - - - - Dictionary MmsDeliveryInfo  - - - - - - - - - - - -->
<section>
  <h2><a>MmsDeliveryInfo</a> Dictionary</h2>
  <dl title="dictionary MmsDeliveryInfo" class="idl">
    <dt>DeliveryStatus deliveryStatus</dt>
    <dd>
    The delivery status of the MMS message to a specific recipient.
    </dd>
    <dt>DOMString recipient</dt>
    <dd>
    The recipient of the MMS to which the delivery status is related.
    </dd>
    <dt>Date deliveryTimestamp</dt>
    <dd>The time the message was delivered to the recipient, i.e. the 'Date'
    field in the M-Delivery.ind Protocol Data Unit [[!MMS13]]. It is not
    provided if there is no positive knowledge about the delivery of the
    message.</dd>
  </dl>    
</section>
    
<!-- - - - - - - - - - - - Interface Conversation  - - - - - - - - - - - - - -->
<section>
  <h2><a>Conversation</a> Interface</h2>
  <p>The <a>Conversation</a> interface represents a set of messages that are
  grouped together either because they are exchanged among the same set of
  participants or because they have the same subject.
  <dl title="interface Conversation"
      class="idl">
    <dt>readonly attribute DOMString conversationID</dt>
    <dd>MUST return the identifier of the conversation, which is globally unique
    within the implementation, i.e. there cannot be any other conversation with
    the same identifier.</dd>

    <dt>readonly attribute MessageType type</dt>
    <dd>MUST return the type of conversation, with value 'participants' if the
    conversation is defined as the set of messages exchanged among the same set
    of parties, and 'subject' if the conversation is defined as the set of
    messages with the same subject.</dd>

    <dt>readonly attribute DOMString[] participants</dt>
    <dd>MUST return an array containing the participants in the conversation. In
    case the conversation is of type 'subject' and there are messages in the
    conversation with a different set of participants then this attribute MUST
    return the union of the participants of all the messages in the
    conversation.</dd>

    <dt>readonly attribute DOMString subject</dt>
    <dd>MUST return the subject of the conversation, if there is a single
    one.</dd>

    <dt>readonly attribute DOMString[] messageTypes</dt>
    <dd>MUST return an array contining the different types of messages included
    in the conversation.</dd>

    <dt>readonly attribute unsigned long messageCount</dt>
    <dd>MUST return the number of messages in the conversation.</dd>

    <dt>readonly attribute unsigned long unreadCount</dt>
    <dd>MUST return the number of unread messages in the conversation.</dd>

    <dt>readonly attribute DOMString lastMessageID</dt>
    <dd>MUST return the identifier of the message in the conversation with the
    most recent timestamp.</dd>

    <dt>readonly attribute MessageCursor cursor</dt>
    <dd>MUST return the <code>MessageCursor</code> to access the messages in
    this conversation.</dd>

  </dl>
</section>

<!-- - - - - - - - - - - - Interface MessagingCursor - - - - - - - - - - - - -->
<section>
  <h2><a>MessagingCursor</a> Interface</h2>
  <p>The <a>MessagingCursor</a> interface allows to iterate through a list of
  <code>Conversation</code> elements or of messages (<code>SmsMessage</code>
  and/or <code>MmsMessage</code> elements).</p>
  <p>A <a>MessagingCursor</a> always has, an <dfn>associated request</dfn> which
  is the <a>Promise</a> that created it.</p>
  <p>As soon as the <a>MessagingCursor</a> is <dfn>accessing an element</dfn>,
  it MUST put its <a>associated request</a> in the 'processing'
  <code>readyState</code>, and set the <code>result</code> to null. Then, the UA
  MUST fetch the next/previous element asynchronously. When the element is
  retrieved, the <a>associated request</a>'s <code>readyState</code> must be set
  to 'done' and the <code>result</code> must point to the cursor. If no element
  was found, the cursor's <code>element</code> property must return null.</p>
  <dl title="interface MessagingCursor"
      class="idl">
    <dt>readonly attribute any? element</dt>
    <dd>
      This property MUST return the currently accessed element. If the cursor
      went past the last element or if it is currently <a>accessing the next
      element</a>, it MUST return null.
    </dd>
    <dt>void next()</dt>
    <dd>
      When this method is called, the cursor MUST change its internal state to
      <a>accessing an element</a> and proceed to access to the next element.
      <br>If this method is called while the cursor is in the process of
      <a>accessing an element</a>, the method MUST throw an
      <code>"InvalidStateError"</code> error as defined in [[!DOM4]].
    </dd>
    <dt>void previous()</dt>
    <dd>
      When this method is called, the cursor MUST change its internal state to
      <a>accessing an element</a> and proceed to access to the previous element.
      <br>If this method is called while the cursor is in the process of
      <a>accessing an element</a>, the method MUST throw an
      <code>"InvalidStateError"</code> error as defined in [[!DOM4]].
    </dd>
  </dl>
</section>


<!-- - - - - - - - - - - - Interface ReceivedMessage - - - - - - - - - - - - -->
<section>
  <h2><a>ReceivedMessage</a> Interface</h2>
  <p>The <a>ReceivedMessage</a> interface represents a system message related to
  a received message. This event is originated from the system and will start
  the application if it is not currently running.

  <p>The application that consumes this API SHOULD set a message handler for the
  <code>ReceivedMessage</code> system message to listen for when a system
  message related to a received message is fired.

  <dl title="interface ReceivedMessage"
      class="idl">
    <dt>readonly attribute (SmsMessage or MmsMessage) message</dt>
    <dd>MUST return the <code>SmsMessage</code> or <code>MmsMessage</code>
    object to which this system message is related.</dd>
  </dl>
</section>


<!-- - - - - - - - - - - - Interface DeliveryReport  - - - - - - - - - - - - -->
<section>
  <h2><a>DeliveryReport</a> Interface</h2>
  <p>The <a>DeliveryReport</a> interface represents a system message related to
  a delivery report of a sent message. This event is originated from the system
  and will start the application if it is not currently running. 

  <p>The application that consumes this API MAY set a message handler for the
  <code>DeliveryReport</code> system message to listen for when a system
  message related to a received delivery report is fired.

  <dl title="interface DeliveryReport"
      class="idl">
    <dt>readonly attribute DOMString serviceID</dt>
    <dd>MUST return the identifier of the service used to send the message to
    which this delivery report is related.</dd>
    <dt>readonly attribute DOMString messageID</dt>
    <dd>MUST return the identifier of the message to which this delivery
    report is related.</dd>
    <dt>readonly attribute DOMString[] recipients</dt>
    <dd>MUST return an array contining the addresses of the subset of the
    original recipients of the message to which this delivery report is
    related. As delivery reports related to just part of the recipients of the
    MMS message are possible, this array may not contain the full list of
    recipients to which the MMS message was sent. If the delivery report is
    related to an SMS message then the array will contain a single item
    corresponding to the single recipient of the SMS message.
    </dd>
    <dt>readonly attribute Date[]? deliveryTimestamps</dt>
    <dd>MUST return an array containing the delivery dates for each of the
    recipients to which this delivery report event relates. Each element in the
    array refers to the recipient in the same position of the
    <code>recipients</code> array. It MUST return null if case of delivery
    failure (e.g. message expired)
    </dd>
  </dl>
</section>


<!-- - - - - - - - - - - - Interface MessagingEvent  - - - - - - - - - - - - -->
<section>
  <h2><a>MessagingEvent</a> Interface</h2>
  <p>The <a>MessagingEvent</a> interface represents events related to a message
  sent or received.
  <dl title="interface MessagingEvent"
      class="idl">
    <dt>readonly attribute (SmsMessage or MmsMessage) message</dt>
    <dd>MUST return the <code>SmsMessage</code> or <code>MmsMessage</code>
    object to which this event is related.</dd>
  </dl>
</section>


<!-- - - - - - - - - - - - Interface DeliveryReportEvent - - - - - - - - - - -->
<section>
  <h2><a>DeliveryReportEvent</a> Interface</h2>
  <p>The <a>DeliveryReportEvent</a> interface represents events related
  to a delivery report of a sent message.
  <dl title="interface DeliveryReportEvent : Event"
      class="idl">
    <dt>readonly attribute DOMString serviceID</dt>
    <dd>MUST return the identifier of the service used to send the message to
    which this delivery report event is related.</dd>
    <dt>readonly attribute DOMString messageID</dt>
    <dd>MUST return the identifier of the message to which this delivery
    report event is related.</dd>
    <dt>readonly attribute DOMString[] recipients</dt>
    <dd>MUST return an array contining the addresses of the subset of the
    original recipients of the message to which this delivery report event is
    related. As delivery reports related to just part of the recipients of the
    MMS message are possible, this array may not contain the full list of
    recipients to which the MMS message was sent. If the delivery report is
    related to an SMS message then the array will contain a single item
    corresponding to the single recipient of the SMS message.
    </dd>
    <dt>readonly attribute Date[]? deliveryTimestamps</dt>
    <dd>MUST return an array containing the delivery dates for each of the
    recipients to which this delivery report event relates. Each element in the
    array refers to the recipient in the same position of the
    <code>recipients</code> array. It MUST return null if case of delivery
    failure (e.g. message expired)
    </dd>
  </dl>
</section>


<!-- - - - - - - - - - - - Interface ServiceChangeEvent  - - - - - - - - - - -->
<section>
  <h2><a>ServiceChangeEvent</a> Interface</h2>
  <p>The <a>ServiceChangeEvent</a> interface represents events related to
  messaging services enabled or disabled.
  <dl title="interface ServiceChangeEvent : Event"
      class="idl">
    <dt>readonly attribute DOMString serviceID</dt>
    <dd>MUST return the identifier of the messaging service which is enabled or
    disabled.</dd>
  </dl>
</section>


<!-- - - - - - - - - - - - Dictionary MessagingFilter  - - - - - - - - - - - -->
<section>
  <h2><a>MessagingFilter</a> Dictionary</h2>
  <p>The <a>MessagingFilter</a> Dictionary represents a filter that is used to
  select a set of messages (e.g. to be provided upon invoking the
  <code>findMessages</code> or the <code>findConversations</code> method in the
  <code>Messaging</code> interface).
  <dl title="dictionary MessagingFilter"
      class="idl">
    <dt>MessageType type</dt>
    <dd>Indicates whether just the SMS or MMS messages are to be provided in the
    results of this filter, respectively if it is set to string value 'SMS' or
    'MMS'.
    </dd>

    <dt>Date startDate</dt>
    <dd>Indicates that messages with timestamp previous to this date will not be
    provided in the results of this filter.</dd>

    <dt>Date endDate</dt>
    <dd>Indicates that messages with timestamp after this date will not be
    provided in the results of this filter.</dd>

    <dt>DOMString from</dt>
    <dd>Indicates that just messages sent from this number are to be provided in
    the results of this filter.</dd>

    <dt>sequence&lt;DOMString&gt; recipients</dt>
    <dd>Indicates that just messages sent to one of these numbers are to be
    provided in the results of this filter.</dd>

    <dt>(SmsState or MmsState) state</dt>
    <dd>Indicates whether the results of this filter just needs to return the
    messages matching the indicated state.
    
    <dt>DOMString serviceID</dt>
    <dd>Indicates that just messages associated to the messaging service with
    this identifier are to be provided in the results of this filter.</dd>

    <dt>boolean read</dt>
    <dd>Indicates whether just read or unread messages are to be provided in the
    results of this filter, respectively if it is set to 'true' or 'false'.</dd>

  </dl>
</section>

<!-- - - - - - - - - - - - Dictionary FilterOptions  - - - - - - - - - - - - -->
<section>
  <h2><a>FilterOptions</a> Dictionary</h2>
  <dl title="dictionary FilterOptions" class="idl">
    <dt>DOMString sortBy</dt>
    <dd>Indicates the attribute on which the filtered messages are sorted.</dd>

    <dt>DOMString sortOrder</dt>
    <dd>Indicates the order on which the filtered messages are sorted with
    possible values 'ascending' and 'descending'.</dd>

    <dt>unsigned long limit</dt>
    <dd>Indicates the maximum number of messages that can be returned as a
    result of applying the corresponding filter.</dd>

  </dl>    
</section>

<!-- - - - - - - - - - - - Interface Enumerations  - - - - - - - - - - - - - -->
  <section>
    <h2>Enumerations</h2>

    <p>The attibute <code>type</code> can have the following values:
    <dl class="idl" title="enum MessageType">
          <dt>sms</dt>
          <dd>
              Corresponding to SMS message(s).
          </dd>

          <dt>mms</dt>
          <dd>
              Corresponding to MMS message(s).
          </dd>
    </dl>

    <p>The attibute <code>messageClass</code> in an <code>SmsMessage</code> can have
    the following values:
    <dl class="idl" title="enum MessageClass">
          <dt>class-0</dt>
          <dd>
              The message is of class 0.
          </dd>

          <dt>class-1</dt>
          <dd>
              The message is of class 1.
          </dd>

          <dt>class-2</dt>
          <dd>
              The message is of class 2.
          </dd>

          <dt>class-3</dt>
          <dd>
              The message is of class 3.
          </dd>

          <dt>normal</dt>
          <dd>
              The message is of class 1 (same as 'class-1').
          </dd>
    </dl>
    <p>The attibute <code>state</code> in an <code>SmsMessage</code> can have
    the following values:
    <dl class="idl" title="enum SmsState">
          <dt>received</dt>
          <dd>
              The message is an inbound message.
          </dd>

          <dt>sending</dt>
          <dd>
              The message is in process of being sent.
          </dd>

          <dt>sent</dt>
          <dd>
              The message has been successfully sent.
          </dd>

          <dt>failed</dt>
          <dd>
              The message is an outbound message whose submission has failed.
          </dd>
    </dl>

    <p>The attibute <code>state</code> in an <code>MmsMessage</code> can have
    the following values:
    <dl class="idl" title="enum MmsState">
          <dt>not-downloaded</dt>
          <dd>
              The message is an inbound message, for which an MMS notification
              has been received but that has not yet been downloaded.
          </dd>

          <dt>fetching</dt>
          <dd>
              The message is an inbound message, for which an MMS notification
              has been received, and whose download has started and not yet
              finished.
          </dd>
          
          <dt>received</dt>
          <dd>
              The message is an inbound message.
          </dd>

          <dt>sending</dt>
          <dd>
              The message is in process of being sent.
          </dd>

          <dt>sent</dt>
          <dd>
              The message has been successfully sent.
          </dd>

          <dt>failed</dt>
          <dd>
              The message is an outbound message whose submission has failed.
          </dd>
    </dl>

    <p>The attibute <code>deliveryStatus</code> can have the following values:
    <dl class="idl" title="enum DeliveryStatus">
          <dt>success</dt>
          <dd>
              The message has been succesfully delivered to the recipient.
          </dd>

          <dt>pending</dt>
          <dd>
              The message is pending delivery.
          </dd>

          <dt>error</dt>
          <dd>
              The delivery of the message has failed.
          </dd>

          <dt>not-applicable</dt>
          <dd>
              The delivery status is not applicable either because a delivery
              report has not been requested or because the message is an inbound
              message
          </dd>
    </dl>

    <p>The MMS fetch mode can have the following values:
    <dl class="idl" title="enum FetchMode">
          <dt>automatic</dt>
          <dd>
              MMS message is fecthed right after the reception of the MMS
              notification.
          </dd>

          <dt>automatic-home</dt>
          <dd>
              MMS message is fecthed right after the reception of the MMS
              notification if the device is located in the home network, i.e.
              not roaming, otherwise the message will be fetched upon the device
              entering in the home network again or the user manually requesting
              it.
          </dd>

          <dt>manual</dt>
          <dd>
              The message is not fecthed until the user manually requests it.
          </dd>

          <dt>never</dt>
          <dd>
              MMS message retrieval is completely disabled.
          </dd>
          
    </dl>

    </section>
  
  
<!-- - - - - - - - - - - - Acknowledgements  - - - - - - - - - - - - - - - - -->
<section>
  <h2>Acknowledgements</h2>
  <p>The editors would like to express their gratitude to the Mozilla B2G Team
  and specially to Jonas Sicking, Mounir Lamouri and Vicamo Yang for their
  technical guidance, implementation work and support.</p>
</section>

  </body>
</html>
